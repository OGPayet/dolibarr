diff a/htdocs/custom/equipement/listSubEquip.php b/htdocs/custom/equipement/listSubEquip.php	(rejected hunks)
@@ -89,10 +89,11 @@ if ($scomposition_fk_soc_fourn=="-1")
 	$scomposition_fk_soc_fourn="";
 
 // on ne prend que les équipement qui matche et qui rentrent déjà dans une composition
-$sql = "SELECT distinct e.rowid FROM ".MAIN_DB_PREFIX."equipement as e,";
-$sql.= MAIN_DB_PREFIX."equipementassociation as ea" ;
-$sql.= " WHERE e.entity = ".$conf->entity;
-$sql.= " and ea.fk_equipement_fils = e.rowid ";
+$sql  = "SELECT ea.fk_equipement_pere";
+$sql .= " FROM "  . MAIN_DB_PREFIX . "equipementassociation as ea";
+$sql .= " INNER JOIN "  . MAIN_DB_PREFIX . "equipement as e ON e.rowid = ea.fk_equipement_fils";
+$sql .= " INNER JOIN "  . MAIN_DB_PREFIX . "equipement as epere ON epere.rowid = ea.fk_equipement_pere";
+$sql .= " WHERE e.entity = " . $conf->entity;
 if ($scomposition_ref)			$sql .= " AND e.ref like '%".$db->escape($scomposition_ref)."%'";
 if ($scomposition_numversion)	$sql .= " AND e.numversion like '%".$db->escape($scomposition_numversion)."%'";
 if ($scomposition_productid)	$sql .= " AND e.fk_product = ".$scomposition_productid;
@@ -110,10 +111,7 @@ if ($scomposition_ref.$scomposition_numversion.$scomposition_productid.$scomposi
 		$i=0;
 		while ($i < $num) {
 			$objp = $db->fetch_object($result);
-			$equipementstatic=new Equipement($db);
-			$tmpId = $equipementstatic->get_firstParent($objp->rowid);
-			// si pas déjà dans la liste, on le rajoute
-			$ListEquipmentParent .= $tmpId.", ";
+            $ListEquipmentParent .= $objp->fk_equipement_pere . ", ";
 			$i++;
 		}
 		// on vire la dernière virgule et l'espace
@@ -365,8 +363,15 @@ if ($result) {
 
 		print "<td nowrap align='center'>".dol_print_date($db->jdate($objp->dateo), 'day')."</td>\n";
 		print "<td nowrap align='center'>".dol_print_date($db->jdate($objp->datee), 'day')."</td>\n";
-		print '<td align="right">'.$langs->trans($objp->etatequiplibelle).'</td>';
-		print '<td align="right">'.$equipementstatic->LibStatut($objp->fk_statut, 5).'</td>';
+
+		print '<td align="right">';
+        if($objp->etatequiplibelle)
+        {
+            print $langs->trans($objp->etatequiplibelle);
+        }
+        print '</td>';
+
+        print '<td align="right">'.$equipementstatic->LibStatut($objp->fk_statut, 5).'</td>';
 		print "</tr>\n";
 		$i++;
 	}
